@model ASM1.WebMVC.Models.QuotationDetailViewModel
@{
    ViewData["Title"] = "Chi tiết báo giá #" + Model.QuotationId;
}

<style>
    .quotation-container {
        background-color: #fff;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 30px;
        margin: 20px auto;
        max-width: 800px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .quotation-header {
        text-align: center;
        border-bottom: 2px solid #333;
        padding-bottom: 20px;
        margin-bottom: 30px;
    }
    
    .company-info {
        text-align: center;
        margin-bottom: 10px;
    }
    
    .quotation-title {
        font-size: 24px;
        font-weight: bold;
        color: #333;
        margin: 15px 0;
    }
    
    .info-section {
        margin-bottom: 25px;
    }
    
    .section-title {
        font-size: 16px;
        font-weight: bold;
        color: #333;
        border-bottom: 1px solid #ddd;
        padding-bottom: 5px;
        margin-bottom: 15px;
    }
    
    .info-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .info-table td {
        padding: 8px 0;
        border-bottom: 1px solid #f5f5f5;
    }
    
    .info-table td:first-child {
        width: 30%;
        font-weight: bold;
        color: #666;
    }
    
    .price-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
    }
    
    .price-table th,
    .price-table td {
        padding: 10px;
        text-align: left;
        border-bottom: 1px solid #ddd;
    }
    
    .price-table th {
        background-color: #f8f9fa;
        font-weight: bold;
    }
    
    .price-table .amount {
        text-align: right;
        font-weight: bold;
    }
    
    .total-row {
        background-color: #e9ecef;
        font-weight: bold;
        font-size: 18px;
    }
    
    .final-price {
        background-color: #d4edda;
        color: #155724;
        text-align: center;
        padding: 15px;
        border-radius: 5px;
        margin-top: 20px;
        font-size: 20px;
        font-weight: bold;
    }
    
    .status-badge {
        display: inline-block;
        padding: 5px 15px;
        border-radius: 15px;
        font-weight: bold;
        font-size: 12px;
        text-transform: uppercase;
    }
    
    .status-pending { background-color: #fff3cd; color: #856404; }
    .status-approved { background-color: #d4edda; color: #155724; }
    .status-cancelled { background-color: #f8d7da; color: #721c24; }
    
    .actions {
        text-align: center;
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid #ddd;
    }
    
    .btn {
        padding: 8px 20px;
        margin: 0 5px;
        border: none;
        border-radius: 4px;
        text-decoration: none;
        display: inline-block;
        cursor: pointer;
    }
    
    .btn-primary { background-color: #007bff; color: white; }
    .btn-secondary { background-color: #6c757d; color: white; }
    .btn-success { background-color: #28a745; color: white; }
    .btn-warning { background-color: #ffc107; color: #212529; }
    .btn-danger { background-color: #dc3545; color: white; }
    
    @@media print {
        .actions { display: none; }
        .quotation-container { box-shadow: none; border: none; }
    }
</style>

<div class="quotation-container">
    <!-- Header -->
    <div class="quotation-header">
        <div class="company-info">
            <h2>CÔNG TY TNHH AUTOSALES</h2>
            <p>Địa chỉ: 123 Đường ABC, Quận XYZ, TP.HCM</p>
            <p>Điện thoại: (028) 1234-5678 | Email: info@autosales.com</p>
        </div>
        <div class="quotation-title">BÁO GIÁ BÁN XE</div>
        <div>
            <strong>Mã báo giá: #@Model.QuotationId</strong>
            <span class="status-badge status-@(Model.Status?.ToLower() ?? "pending")">
                @(Model.Status?.ToUpper() ?? "CHỜ DUYỆT")
            </span>
        </div>
    </div>

    <!-- Thông tin báo giá -->
    <div class="info-section">
        <div class="section-title">THÔNG TIN BÁO GIÁ</div>
        <table class="info-table">
            <tr>
                <td>Ngày tạo:</td>
                <td>@(Model.CreatedAt?.ToString("dd/MM/yyyy") ?? "Chưa xác định")</td>
            </tr>
            <tr>
                <td>Thời gian:</td>
                <td>@(Model.CreatedAt?.ToString("HH:mm") ?? "Chưa xác định")</td>
            </tr>
            <tr>
                <td>Nhân viên tư vấn:</td>
                <td>@Model.DealerName</td>
            </tr>
            <tr>
                <td>Thời hạn báo giá:</td>
                <td>30 ngày</td>
            </tr>
        </table>
    </div>

    <!-- Thông tin khách hàng -->
    <div class="info-section">
        <div class="section-title">THÔNG TIN KHÁCH HÀNG</div>
        <table class="info-table">
            <tr>
                <td>Họ và tên:</td>
                <td>@Model.CustomerName</td>
            </tr>
            <tr>
                <td>Email:</td>
                <td>@Model.CustomerEmail</td>
            </tr>
            <tr>
                <td>Số điện thoại:</td>
                <td>@(Model.CustomerPhone ?? "Chưa có")</td>
            </tr>
            <tr>
                <td>Mã khách hàng:</td>
                <td>KH@(Model.QuotationId.ToString("D6"))</td>
            </tr>
        </table>
    </div>

    <!-- Thông tin xe -->
    <div class="info-section">
        <div class="section-title">THÔNG TIN XE</div>
        <table class="info-table">
            <tr>
                <td>Hãng xe:</td>
                <td>@Model.VehicleBrand</td>
            </tr>
            <tr>
                <td>Dòng xe:</td>
                <td>@Model.VehicleModel</td>
            </tr>
            <tr>
                <td>Phiên bản:</td>
                <td>@Model.VehicleVersion</td>
            </tr>
            <tr>
                <td>Màu sắc:</td>
                <td>@(Model.VehicleColor ?? "Chưa xác định")</td>
            </tr>
            <tr>
                <td>Năm sản xuất:</td>
                <td>@(Model.VehicleYear?.ToString() ?? "Chưa xác định")</td>
            </tr>
            <tr>
                <td>Bảo hành:</td>
                <td>3 năm hoặc 100.000 km</td>
            </tr>
        </table>
    </div>

    <!-- Chi tiết giá -->
    <div class="info-section">
        <div class="section-title">CHI TIẾT GIÁ BÁN</div>
        <table class="price-table">
            <thead>
                <tr>
                    <th>Mô tả</th>
                    <th class="amount">Số tiền (VND)</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model.PriceBreakdown)
                {
                    <tr>
                        <td>@item.Description</td>
                        <td class="amount">
                            @if (item.Type == "discount")
                            {
                                <span style="color: green;">-@(item.Amount.ToString("N0"))</span>
                            }
                            else
                            {
                                @(item.Amount.ToString("N0"))
                            }
                        </td>
                    </tr>
                }
            </tbody>
            <tfoot>
                <tr class="total-row">
                    <td>TỔNG CỘNG</td>
                    <td class="amount">@(Model.FinalPrice.ToString("N0"))</td>
                </tr>
            </tfoot>
        </table>
    </div>

    <!-- Giá cuối cùng -->
    <div class="final-price">
        TỔNG GIÁ BÁN: @(Model.FinalPrice.ToString("N0")) VND
        <br><small>(Đã bao gồm thuế VAT 10%)</small>
    </div>

    <!-- Thông tin bổ sung -->
    @if (!string.IsNullOrEmpty(Model.DiscountDescription) || !string.IsNullOrEmpty(Model.FeesDescription))
    {
        <div class="info-section">
            <div class="section-title">THÔNG TIN BỔ SUNG</div>
            @if (!string.IsNullOrEmpty(Model.DiscountDescription))
            {
                <p><strong>Khuyến mãi:</strong> @Model.DiscountDescription</p>
            }
            @if (!string.IsNullOrEmpty(Model.FeesDescription))
            {
                <p><strong>Phí bổ sung:</strong> @Model.FeesDescription</p>
            }
            <p><strong>Thuế suất VAT:</strong> @(Model.TaxRate.ToString("P0"))</p>
        </div>
    }

    <!-- Footer -->
    <div class="info-section">
        <div class="section-title">THÔNG TIN LIÊN HỆ</div>
        <table class="info-table">
            <tr>
                <td>Nhân viên tư vấn:</td>
                <td>@Model.DealerName</td>
            </tr>
            <tr>
                <td>Điện thoại:</td>
                <td>0901.234.567</td>
            </tr>
            <tr>
                <td>Email:</td>
                <td>sales@autosales.com</td>
            </tr>
            <tr>
                <td>Showroom:</td>
                <td>123 Đường ABC, Quận XYZ, TP.HCM</td>
            </tr>
        </table>
    </div>

    <div style="text-align: center; margin-top: 20px; padding-top: 15px; border-top: 1px solid #ddd; font-size: 12px; color: #666;">
        Báo giá này có hiệu lực trong 30 ngày kể từ ngày tạo.<br>
        Trang 1/1 - Mã báo giá: #@Model.QuotationId - Tạo lúc: @(DateTime.Now.ToString("dd/MM/yyyy HH:mm"))
    </div>

    <!-- Action Buttons -->
    <div class="actions">
        <a asp-action="Index" class="btn btn-secondary">Quay lại danh sách</a>
        <button onclick="window.print()" class="btn btn-primary">In báo giá</button>
        <a asp-action="Edit" asp-route-id="@Model.QuotationId" class="btn btn-warning">Chỉnh sửa</a>
        <button class="btn btn-success" onclick="approveQuotation(@Model.QuotationId)">Duyệt báo giá</button>
        <button class="btn btn-danger" onclick="cancelQuotation(@Model.QuotationId)">Hủy báo giá</button>
    </div>
</div>

@Html.AntiForgeryToken()

<script>
    function approveQuotation(id) {
        if (confirm('Bạn có chắc chắn muốn duyệt báo giá này?')) {
            fetch(`/Quotation/Approve/${id}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': document.querySelector('[name="__RequestVerificationToken"]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Báo giá đã được duyệt thành công!');
                    location.reload();
                } else {
                    alert('Có lỗi xảy ra khi duyệt báo giá');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Có lỗi xảy ra khi duyệt báo giá');
            });
        }
    }

    function cancelQuotation(id) {
        if (confirm('Bạn có chắc chắn muốn hủy báo giá này?')) {
            fetch(`/Quotation/Cancel/${id}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': document.querySelector('[name="__RequestVerificationToken"]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Báo giá đã được hủy thành công!');
                    location.reload();
                } else {
                    alert('Có lỗi xảy ra khi hủy báo giá: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Có lỗi xảy ra khi hủy báo giá');
            });
        }
    }
</script>